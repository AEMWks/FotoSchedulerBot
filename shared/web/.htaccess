# shared/web/.htaccess - Configuración corregida para el enrutador de APIs

RewriteEngine On

# Headers CORS para todas las requests
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
Header always set Access-Control-Max-Age "86400"

# Manejar preflight OPTIONS requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# ==========================================
# API ROUTING - Todo va al enrutador principal
# ==========================================

# Redirigir todas las llamadas de API al enrutador principal
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ api/index.php [QSA,L]

# Si se accede directamente a /api sin path, también va al enrutador
RewriteRule ^api/?$ api/index.php [QSA,L]

# ==========================================
# STATIC FILES - Servir archivos estáticos directamente
# ==========================================

# Assets (CSS, JS, imágenes)
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^assets/(.*)$ assets/$1 [L]

# Fotos - servir directamente desde /photos
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^photos/(.*)$ photos/$1 [L]

# ==========================================
# DEFAULT ROUTING - Páginas principales
# ==========================================

# Si no es API ni asset, y el archivo no existe, servir index.html
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^(.*)$ index.html [L]

# ==========================================
# HEADERS DE CACHE
# ==========================================

# Cache largo para assets estáticos
<FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
    Header set Cache-Control "max-age=31536000, public"
    Header set Expires "Thu, 31 Dec 2037 23:55:55 GMT"
</FilesMatch>

# No cache para APIs
<FilesMatch "\.php$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</FilesMatch>

# Cache corto para páginas HTML
<FilesMatch "\.html$">
    Header set Cache-Control "max-age=300, public"
</FilesMatch>

# ==========================================
# COMPRESIÓN
# ==========================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# ==========================================
# SEGURIDAD
# ==========================================

# Prevenir acceso a archivos sensibles
<Files "*.json">
    <RequireAll>
        Require all denied
    </RequireAll>
</Files>

<Files "*.log">
    <RequireAll>
        Require all denied
    </RequireAll>
</Files>

<Files "*.md">
    <RequireAll>
        Require all denied
    </RequireAll>
</Files>

# Proteger archivos de configuración (pero permitir que PHP los incluya)
<Files "config.php">
    <RequireAll>
        Require all denied
    </RequireAll>
</Files>

# Proteger el directorio utils
<Directory "api/utils">
    <RequireAll>
        Require all denied
    </RequireAll>
</Directory>

# ==========================================
# CONFIGURACIÓN DE DIRECTORIOS
# ==========================================

# Directorio de fotos - solo lectura
<Directory "photos">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted

    # Prevenir ejecución de scripts
    <FilesMatch "\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$">
        Require all denied
    </FilesMatch>
</Directory>

# Directorio de assets
<Directory "assets">
    Options -Indexes
    AllowOverride None
    Require all granted
</Directory>

# Directorio de APIs
<Directory "api">
    Options -Indexes
    AllowOverride None
    Require all granted

    # Solo permitir archivos PHP
    <FilesMatch "\.php$">
        Require all granted
    </FilesMatch>
</Directory>

# ==========================================
# ERROR HANDLING
# ==========================================

# Página de error personalizada para APIs
ErrorDocument 404 /api/index.php

# ==========================================
# CONFIGURACIÓN DE SEGURIDAD ADICIONAL
# ==========================================

# Prevenir información del servidor
ServerTokens Prod
ServerSignature Off

# Headers de seguridad básica
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # CSP básico para la aplicación
    Header always set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self'; font-src 'self' data:; connect-src 'self';"
</IfModule>

# ==========================================
# LOGS Y DEBUGGING
# ==========================================

# Log de rewrite para debugging (desactivar en producción)
# RewriteLog /var/log/apache2/rewrite.log
# RewriteLogLevel 3

# Log personalizado para APIs
<IfModule mod_setenvif.c>
    SetEnvIf Request_URI "^/api/" api_request
    CustomLog logs/api_access.log combined env=api_request
</IfModule>

# ==========================================
# CONFIGURACIÓN ESPECÍFICA PARA DEVELOPMENT
# ==========================================

# Solo en desarrollo - mostrar errores de PHP
<If "%{ENV:DEBUG_MODE} == 'true'">
    php_flag display_errors On
    php_flag log_errors On
</If>

# En producción - ocultar errores
<If "%{ENV:DEBUG_MODE} != 'true'">
    php_flag display_errors Off
    php_flag log_errors On
</If>
