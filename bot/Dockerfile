FROM python:3.11-slim

# Configurar zona horaria
ENV TZ=Europe/Madrid
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Actualizar repositorios primero
RUN apt-get update

# Instalar solo dependencias bÃ¡sicas y disponibles
RUN apt-get install -y --no-install-recommends \
    curl \
    tzdata \
    build-essential \
    pkg-config \
    libjpeg62-turbo-dev \
    libpng-dev \
    libfreetype6-dev \
    zlib1g-dev \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

# Crear directorio para el bot
WORKDIR /app

# Copiar requirements.txt primero
COPY requirements.txt .

# Instalar dependencias de Python (sin OpenCV por ahora)
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir python-telegram-bot==20.8 APScheduler==3.10.4 Pillow==10.1.0

# Intentar instalar OpenCV, pero continuar si falla
RUN pip install --no-cache-dir opencv-python-headless==4.8.1.78 || \
    echo "âš ï¸ OpenCV no se pudo instalar, continuando sin validaciÃ³n de video"

# Copiar el script del bot
COPY bot.py .

# Variables de entorno
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# Crear directorio de fotos
RUN mkdir -p /data/fotos

# Variables de entorno para tokens
ENV TELEGRAM_BOT_TOKEN=""
ENV TELEGRAM_USER_ID=""

# Script de entrada simplificado
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ðŸš€ Iniciando bot de fotos..."\n\
\n\
# Configurar umask\n\
umask 002\n\
\n\
# Crear y configurar directorio de fotos\n\
mkdir -p /data/fotos\n\
chown -R 33:33 /data/fotos 2>/dev/null || echo "âš ï¸ No se pudo cambiar ownership"\n\
chmod -R 775 /data/fotos 2>/dev/null || echo "âš ï¸ No se pudieron configurar permisos"\n\
\n\
# Verificar dependencias\n\
echo "ðŸ“¦ Verificando dependencias..."\n\
python3 -c "import telegram; print(\"âœ… python-telegram-bot ok\")" || echo "âŒ telegram error"\n\
python3 -c "from apscheduler.schedulers.asyncio import AsyncIOScheduler; print(\"âœ… APScheduler ok\")" || echo "âŒ scheduler error"\n\
python3 -c "from PIL import Image; print(\"âœ… Pillow ok\")" || echo "âš ï¸ Pillow error"\n\
python3 -c "import cv2; print(\"âœ… OpenCV ok\")" || echo "âš ï¸ OpenCV no disponible"\n\
\n\
# Verificar directorio escribible\n\
if [ -w "/data/fotos" ]; then\n\
    echo "âœ… Directorio escribible"\n\
else\n\
    echo "âŒ Directorio no escribible"\n\
fi\n\
\n\
# Monitoreo de permisos en background\n\
(\n\
    while true; do\n\
        sleep 60\n\
        find "/data/fotos" -type f ! -perm 664 -exec chmod 664 {} \\; 2>/dev/null || true\n\
        find "/data/fotos" -type d ! -perm 775 -exec chmod 775 {} \\; 2>/dev/null || true\n\
        find "/data/fotos" \\( ! -user 33 -o ! -group 33 \\) -exec chown 33:33 {} \\; 2>/dev/null || true\n\
    done\n\
) &\n\
\n\
echo "âœ… Iniciando bot..."\n\
exec python3 bot.py' > /entrypoint.sh

# Hacer ejecutable
RUN chmod +x /entrypoint.sh

# Comando por defecto
CMD ["/entrypoint.sh"]
